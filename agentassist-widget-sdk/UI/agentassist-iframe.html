<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.1, maximum-scale=1.0">
    <title>Agentassist</title>
    <link rel="icon" id="favicon" type="image/x-icon" href="favicon.ico">
    <link href="./../dist/kore-ai-agentassist-sdk.min.css" rel="stylesheet">
    </link>
    <script src="./typeahead.js/jquery_.min.js"></script>
    <!--  -->

    <script src="./typeahead.js/bloodhound.min.js" defer></script>
    <script src="./typeahead.js/typeahead.bundle.min.js" defer></script>
    <script src="./typeahead.js/typeahead.jquery.min.js" defer></script>
    <script src="./../dist/kore-ai-agentassist-sdk.combined.js" type="text/javascript"></script>
    <script>
       window.addEventListener("unload", (event) => {
        window.removeEventListener("message", receiveMessage)
        });
        function receiveMessage(e) {
            if(e.data.name === 'init_agentassist') {
                var chatConfig = window.KoreSDK.chatConfig;
                    let urlParams = e.data.urlParams;
                    initAgentAssist(chatConfig, urlParams);
                }
        }
        $(document).ready(function () {
            console.log('agent assist inside iframe', new Date());
            var chatConfig = window.KoreSDK.chatConfig;
            window.addEventListener("message", receiveMessage, false);
            let parentUrl = document.referrer;
            let params = {};
            if (!parentUrl.includes('localhost')) {
                let params = new Proxy(new URLSearchParams(window.location.search), {
                    get: (searchParams, prop) => searchParams.get(prop),
                });
                initAgentAssist(chatConfig, params);
            } else {
                var message = {
                    method: 'agentassist_loaded',
                    name: "agent_assist"
                };
                window.parent.postMessage(message, "*");
            }
        });
        function initAgentAssist(chatConfig, urlParams) {
            if (chatConfig.agentAssist) {
                var token, botID, agentAssistUrl, conversationId;
                var connectionObj = {
                    envinormentUrl: chatConfig.agentAssistUrl,
                    botDetails: {},
                    isAuthentication: false
                }
                function getToken(urlParams) {
                    console.log('agent assist inside getToken', new Date());
                    let params = new Proxy(new URLSearchParams(window.location.search), {
                        get: (searchParams, prop) => searchParams.get(prop),
                    });
                    if (urlParams) {
                        params = urlParams;
                    }
                    token = params.token;
                    botID = params.botid;
                    agentAssistUrl = params.agentassisturl;
                    conversationId = params.conversationId || params.conversationid;
                    console.log("---conversation id -----", conversationId);
                }
                getToken(urlParams);
                function koreGenerateUUID() {
                    console.info("generating UUID");
                    var d = new Date().getTime();
                    if (window.performance && typeof window.performance.now === "function") {
                        d += performance.now(); //use high-precision timer if available
                    }
                    var uuid = 'ua-xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        var r = (d + Math.random() * 16) % 16 | 0;
                        d = Math.floor(d / 16);
                        return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                    });
                    return uuid;
                }
                if (!token || !botID || !agentAssistUrl || !conversationId) {
                    if (connectionObj.isAuthentication) {
                        connectionObj.botDetails['clientId'] = chatConfig.botOptions.clientId;
                        connectionObj.botDetails['clientSecret'] = chatConfig.botOptions.clientSecret;
                        connectionObj.botDetails['botId'] = chatConfig.botOptions.botInfo._id;
                        conversationId = koreGenerateUUID();
                        new AgentAssist('agent-assist-chat-container', conversationId, connectionObj.botDetails.botId, connectionObj);
                    } else {
                        console.error("failed");// invalid configuration
                        $(`#agent-assist-chat-container`).html('Issue identified in configuration settings! Please reach out to AgentAssist Admin.')
                    }

                } else {
                    console.log('==================================', urlParams)
                    connectionObj['envinormentUrl'] = agentAssistUrl;
                    connectionObj['tokenVal'] = token;
                    connectionObj['accountId'] = urlParams.accountId || '';
                    connectionObj['userId'] = urlParams.userId || '';
                    connectionObj['orgId']= urlParams.orgId || '';
                    connectionObj['isSAT'] = urlParams.fromSAT || false;
                    new AgentAssist('agent-assist-chat-container', conversationId, botID, connectionObj, urlParams);
                }


                // var conversationId;
                // conversationId = (new Date()).getTime() + '';
                // $('#details').val(`ConversationID: ${conversationId}`);
                // botID = $(`#botid`).val() ? $(`#botid`).val() : chatConfig.botOptions.botInfo._id;
                // connectionObj.botDetails.clientId = $(`#clientid`).val() ? $(`#clientid`).val() : connectionObj.botDetails.clientId;
                // connectionObj.botDetails.clientSecret = $(`#clientsecret`).val() ? $(`#clientsecret`).val() : connectionObj.botDetails.clientSecret;

            }
        } 

    </script>
 <script>
    // $(document).ready(function(){
    //   var substringMatcher = function(strs) {
    //       return function findMatches(q, cb) {
    //       var matches, substringRegex;

    //       // an array that will be populated with substring matches
    //       matches = [];

    //       // regex used to determine if a string contains the substring `q`
    //       substrRegex = new RegExp(q, 'i');

    //       // iterate through the pool of strings and for any string that
    //       // contains the substring `q`, add it to the `matches` array
    //       $.each(strs, function(i, str) {
    //         if (substrRegex.test(str)) {
    //           matches.push(str);
    //         }
    //       });

    //       cb(matches);
    //     };
    //   };

    //   var states = ['Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California',
    //     'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii',
    //     'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana',
    //     'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota',
    //     'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire',
    //     'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota',
    //     'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island',
    //     'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont',
    //     'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'
    //   ];

    //   $('#the-basics .typeahead').typeahead({
    //     hint: true,
    //     highlight: true,
    //     minLength: 1
    //   },
    //   {
    //     name: 'states',
    //     source: substringMatcher(states)
    //   });
    // });
  </script>
</head>

<body>

    
    
   
    <div id="agent-assist-chat-container"></div>

</body>

</html>