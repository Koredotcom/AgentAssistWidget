<!DOCTYPE html>
<html>

<head>
    <!-- <link href="./main.css" rel="stylesheet"> -->
    </link>
    <!-- <script src="./agentassist.js" defer ></script> -->
    <script type="text/javascript"
        src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/hmac-sha256.min.js"></script>
    <!-- 
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
        <script type="text/javascript" src="./main.js"></script>  -->

</head>

<body>
    <div style="width: 100%; display: flex; height: 460px!important;">
        <div id="agentassist-maincontainer" style="width: 100%;padding-right: 10px;height: 460px!important;">
            <iframe id="agentassist-iframe" src="about:blank" height="100%" width="100%"></iframe>
        </div>

        <!-- <div id="agentassist-maincontainer2" style="width: 30%;padding-right: 10px;">

        </div>
        <div id="agentassist-maincontainer3" style="width: 30%;">

        </div> -->
    </div>

    <script type="text/javascript">
        /*
            @TODO
            creating custom Object Schema and saving all JWT token related data in custom object
            need to assign UUID to `agentAssistUUID` varible 
        */

        async function main() {
            var client = ZAFClient.init();

            var iframeURL = "";
            client.invoke('resize', { width: '100%', height: '500px' });
            var activeConversationId = await getTicketId(client);

            // client.on('channel.message.received', (event) => {
            //     console.log("chat_event ========> ", event);
            // });

            // client.on('channel.message.sent', (event) => {
            //     console.log("chat sent =========> ", event);
            // });
            client.on('ticket.conversation.changed', function (conversations) {
                // console.log("change event =====> ", e);
                let lastElement = conversations.pop();
                if (lastElement.author.role == "customer") {
                    sendMessageToAgentAssist(activeConversationId, lastElement.message.content);
                }
            });

            var zendeskBaseUrl = `https://self2959.zendesk.com`;
            let agentAssistDataUUID = "d34a70a3-2e6c-11ed-b0aa-af398216b629";
            let customDataUrl = `${zendeskBaseUrl}/api/sunshine/objects/records/${agentAssistDataUUID}`;
            let username = 'himabindub07@gmail.com';
            let password = 'bxvHwC@7';
            let oAuthToken = '4c67db94563d4f79dbfa4b508a25abcc05e26c9c2fac6317f688af56b1361298';

            function sendMessageToAgentAssist(conversationId, message) {
                let iframe = document.getElementById('agentassist-iframe');
                if (!iframe) {
                    return;
                }
                console.log("Kore Agent Assist iframe", iframe);
                var content = message;
                console.log("New Message recordId:" + conversationId + " content:" + content);
                var message = {};
                message['author'] = {};
                message['author'].Id = '';
                message['author'].type = 'USER';
                message['conversationid'] = conversationId;
                message['name'] = 'agentAssist.CustomerMessage';
                message['value'] = content;
                var vfWindow = iframe.contentWindow;
                if (vfWindow) {
                    vfWindow.postMessage(message, iframeURL);//window.location.protocol+'//'+window.location.host);
                }

            }

            async function getTicketId(client) {
                ticket = await client.context();
                if (ticket)
                    return ticket.ticketId

            };


            function base64url(source) {
                // Encode in classical base64
                encodedSource = CryptoJS.enc.Base64.stringify(source);

                // Remove padding equal characters
                encodedSource = encodedSource.replace(/=+$/, '');

                // Replace characters according to base64url specifications
                encodedSource = encodedSource.replace(/\+/g, '-');
                encodedSource = encodedSource.replace(/\//g, '_');

                return encodedSource;
            }

            async function generateURL() {
                return new Promise(async (resolve, reject) => {

                    let headers = new Headers();

                    // var credentials = btoa(`${username}:${password}`);

                    headers.append("Authorization", "Bearer " + oAuthToken);
                    headers.append('Content-Type', 'application/json')

                    let response = await fetch(customDataUrl, { method: 'GET', headers: headers })
                    if (response.ok) { // if HTTP-status is 200-299
                        let json = await response.json();
                        // console.log(json.data);
                        // return json.data;
                        var tokenData = json.data.attributes;
                        var header = {
                            "alg": "HS256",
                            "typ": "JWT"
                        };

                        var stringifiedHeader = CryptoJS.enc.Utf8.parse(JSON.stringify(header));
                        var encodedHeader = base64url(stringifiedHeader);

                        const data = {
                            'iss': tokenData.clientId,
                            'sub': 'number',
                            'aud': tokenData.aud,
                            'botId': tokenData.botId,
                            'isAnonymous': tokenData.isAnonymous

                        }


                        var stringifiedData = CryptoJS.enc.Utf8.parse(JSON.stringify(data));
                        var encodedData = base64url(stringifiedData);

                        var token = encodedHeader + "." + encodedData;
                        // console.log("token ==========================>", token);

                        var secret = tokenData.clientSecret;
                        var signature = CryptoJS.HmacSHA256(token, secret);
                        signature = base64url(signature);

                        var signedToken = token + "." + signature;

                        // console.log("signed token ----==>", signedToken);

                        let customdata = encodeURI(JSON.stringify({ fName: this.customerName || 'Customer', lName: '' }));
                        let smartassistURL = tokenData.agentassistURL.replace("agentassist", "smartassist")
                        iframeURL = `${tokenData.agentassistURL}/koreagentassist-sdk/UI/agentassist-iframe.html?token=${signedToken}&botid=${tokenData.botId}&agentassisturl=${smartassistURL}&conversationid=${activeConversationId}&isCall=false&customdata=${customdata}`;
                        resolve(iframeURL);
                    } else {
                        console.log("HTTP-Error: " + response.status);
                        reject(response.statusText);
                    }
                });
            }

            async function iframeRender() {
                let _iframeURL = await generateURL();

                console.log("Iframe URL ========> ", _iframeURL);
                document.getElementById("agentassist-iframe").src = _iframeURL;
                let ticketData = await client.get('ticket');
                // console.log("ticket data =====> ", ticketData);

            }
            iframeRender();
            client.on('app.registered', (event) => {
                console.log("app registered =========> ", event);
            });
            window.addEventListener("message", async (event) => {
                // console.log("Kore Agent Assist inside window eventlistener", activeConversationId, event.data);
                var recordId = activeConversationId;
                if (event.data.name === "agentAssist.SendMessage" && event.data.conversationId == activeConversationId) {
                    //console.log(event.data.payload);
                    var msg = '';
                    try {
                        msg = JSON.parse(decodeURI(event.data.payload)).message[0].cInfo.body;
                    } catch (e) {
                        msg = decodeURI(encodeURI(event.data.payload));
                    }
                    console.log("Kore Agent Assist sending message ===============> ", msg);
                    client.invoke("ticket.sendMessage", {channel: 'messaging', message: msg});


                } else if (event.data.name === "agentAssist.CopyMessage" && event.data.conversationId == activeConversationId) {
                    var msg = decodeURI(encodeURI(event.data.payload));
                    console.log("Kore Agent Assist copying message ==============> ", msg);
                    client.invoke('comment.appendText', msg);

                }
            }, false);
        }

        main();
    </script>

</body>

</html>