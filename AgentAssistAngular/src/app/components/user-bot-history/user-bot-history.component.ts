import { Component, OnDestroy, OnInit } from '@angular/core';
import { ProjConstants } from 'src/app/proj.const';
import { RootService } from 'src/app/services/root.service';
import { ServiceInvokerService } from 'src/app/services/service-invoker.service';
import { TemplateRenderClassService } from 'src/app/services/template-render-class.service';
import { SubSink } from 'subsink';

@Component({
  selector: 'app-user-bot-history',
  templateUrl: './user-bot-history.component.html',
  styleUrls: ['./user-bot-history.component.scss']
})
export class UserBotHistoryComponent implements OnInit, OnDestroy{

  subs = new SubSink();
  connectionDetails : any;
  historyResponse : any = [];
  projConstants : any = ProjConstants;


  constructor(private rootService : RootService, private serviceInvoker : ServiceInvokerService,
    private templateRenderClassService : TemplateRenderClassService){

  }

  ngOnInit(): void {
    this.subscribeEvents();
  }

  subscribeEvents(){
    this.subs.sink = this.rootService.socketConnection$.subscribe(res => {
      if(res){
        this.connectionDetails  = this.rootService.getConnectionDetails();
        this.getUserBotHistory(this.connectionDetails);
      }
    });
  }

  getUserBotHistory(params){

    let data : any =  
    { "total": 18, "moreAvailable": false, "icon": "https://uat-smartassist.kore.ai:443/api/getMediaStream/market/f-d8a0d4bd-a4ca-5df0-a974-314d5a62ed18.png?n=1579710716&s=Inl1NE1nbTVkN0FBTU5mSEFwSktnN21mMG5vWE53SldvdEljM1BDQXRqaEk9Ig$$",
     "messages": [{ "_id": "ms-5c0d2c4b-1932-5843-bbfe-7d1df271976a", "channels": [{ "to": "631993f5f7a27e7b3731acce/smartassist/6447bb1f9fa67e3b9f425758", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "outgoing", "status": "pending", "createdOn": "2023-04-25T11:36:04.605Z", "lmodifiedOn": "2023-04-25T11:36:04.605Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "components": [{ "_id": "cp-386b9f6e-6b3e-580a-90aa-c75615cdfb33", "cT": "text", "data": { "text": "{\"type\":\"template\",\"payload\":{\"template_type\":\"quick_replies\",\"text\":\"Select an option.\",\"quick_replies\":[{\"content_type\":\"text\",\"title\":\"Pizza\",\"payload\":\"Pizza\"},{\"content_type\":\"text\",\"title\":\"Wanna know anything about pizza ?\",\"payload\":\"Wanna know anything about pizza ?\"},{\"content_type\":\"text\",\"title\":\"Who are the other top pizza makers in the world?\",\"payload\":\"Who are the other top pizza makers in the world?\"},{\"content_type\":\"text\",\"title\":\"what is a pizza crust?\",\"payload\":\"what is a pizza crust?\"}]}}" }, "thumbnails": [] }], "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 0, "lang": "en", "agentAssistDetails": { "streamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "srcChannel": "", "childBotStreamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "experience": "", "userInput": "pizza", "entityRequest": true, "ambiguityList": { "dialogs": [{ "name": "Pizza" }], "faqs": [{ "question": "Wanna know anything about pizza ?", "displayName": "Wanna know anything about pizza ?" }, { "question": "Who are the other top pizza makers in the world?", "displayName": "Who are the other top pizza makers in the world?" }, { "question": "what is a pizza crust?", "displayName": "what is a pizza crust?" }] }, "ambiguity": true, "isPrompt": true }, "timestampValue": 1682422564607, "__v": 0, "sT": 1, "sessionId": "6447ba89093ada397855caeb", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-a0a26309-b414-5502-b869-85f6dcf7f51e", "channels": [{ "to": "631993f5f7a27e7b3731acce/smartassist/6447bb1f9fa67e3b9f425758", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "outgoing", "status": "pending", "createdOn": "2023-04-25T11:51:16.665Z", "lmodifiedOn": "2023-04-25T11:51:16.665Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "components": [{ "_id": "cp-1d6bd20f-1300-503d-aa0c-f561d78ced99", "cT": "text", "data": { "text": "I am closing our current conversation as I have not received any input from you. We can start over when you need." }, "thumbnails": [] }], "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 0, "lang": "en", "agentAssistDetails": { "streamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "srcChannel": "", "childBotStreamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "experience": "", "userInput": "sending a ctrl message to CS" }, "timestampValue": 1682423476680, "__v": 0, "sT": 1, "sessionId": "6447ba89093ada397855caeb", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-48fcb0c3-e009-5032-b7a1-7c156f230b61", "channels": [{ "type": "smartassist" }], "type": "timelinemsg", "status": "pending", "createdOn": "2023-04-25T11:51:16.732Z", "lmodifiedOn": "2023-04-25T11:51:16.732Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 6, "chnl": "smartassist", "components": [{ "_id": "cp-88e17ca6-bf1f-500e-a2e6-4a51a0b828c5", "cT": "text", "data": { "text": "droppedOff" }, "thumbnails": [] }], "timestampValue": 1682423476732, "__v": 0, "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-989ee975-c5ad-5013-871e-114c261a9029", "channels": [{ "to": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "incoming", "status": "received", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "lmodifiedBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "createdOn": "2023-07-05T15:02:46.019Z", "lmodifiedOn": "2023-07-05T15:02:46.019Z", "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "components": [{ "_id": "cp-796e28ed-3e0b-5910-bbce-c7448ce56a26", "cT": "text", "data": { "text": "refreshCS" }, "thumbnails": [] }], "timestampValue": 1688569366036, "__v": 0, "lang": "en", "sT": 1, "sessionId": "64a586161918a012c323b933", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-b108fb71-e84b-5878-afe6-0bc44b85efee", "channels": [{ "to": "631993f5f7a27e7b3731acce/smartassist/64a586150a931b133485885b", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "outgoing", "status": "pending", "createdOn": "2023-07-05T15:02:46.497Z", "lmodifiedOn": "2023-07-05T15:02:46.497Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "components": [{ "_id": "cp-c03e8b4a-7bd7-5748-a115-27aa6c80357e", "cT": "text", "data": { "text": "" }, "thumbnails": [] }], "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "lang": "en", "agentAssistDetails": { "streamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "srcChannel": "", "childBotStreamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "experience": "", "userInput": "refreshCS" }, "timestampValue": 1688569366502, "__v": 0, "sT": 1, "sessionId": "64a586161918a012c323b933", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-9bab1dee-97ab-50cb-9ca0-b0f41addf4bd", "channels": [{ "to": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "incoming", "status": "received", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "lmodifiedBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "createdOn": "2023-07-05T15:02:53.393Z", "lmodifiedOn": "2023-07-05T15:02:53.393Z", "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "components": [{ "_id": "cp-8c209458-c94b-5f58-9a61-a5f49245a919", "cT": "text", "data": { "text": "payment dispute" }, "thumbnails": [] }], "timestampValue": 1688569373398, "__v": 0, "lang": "en", "sT": 1, "sessionId": "64a586161918a012c323b933", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-11a9c8e7-91a1-5083-b773-f778c6f16bec", "channels": [{ "to": "631993f5f7a27e7b3731acce/smartassist/64a586150a931b133485885b", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "outgoing", "status": "pending", "createdOn": "2023-07-05T15:02:54.731Z", "lmodifiedOn": "2023-07-05T15:02:54.731Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "components": [{ "_id": "cp-f579c200-ba6b-5de4-b9a1-3f00735c7592", "cT": "text", "data": { "text": "" }, "thumbnails": [] }], "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "lang": "en", "agentAssistDetails": { "streamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "srcChannel": "", "childBotStreamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "experience": "", "userInput": "payment dispute" }, "timestampValue": 1688569374739, "__v": 0, "sT": 1, "sessionId": "64a586161918a012c323b933", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-0bb703a3-728a-5809-8ac5-01abaf05da1f", "channels": [{ "to": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "incoming", "status": "received", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "lmodifiedBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "createdOn": "2023-07-05T15:14:25.317Z", "lmodifiedOn": "2023-07-05T15:14:25.317Z", "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "components": [{ "_id": "cp-c87259a5-0f34-517b-b3a0-534586dc56d5", "cT": "text", "data": { "text": "refreshCS" }, "thumbnails": [] }], "timestampValue": 1688570065322, "__v": 0, "lang": "en", "sT": 1, "sessionId": "64a586161918a012c323b933", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-3bd8ac8a-3463-5951-bc83-2ea89a2b5a55", "channels": [{ "to": "631993f5f7a27e7b3731acce/smartassist/64a588d10a931b1334858a31", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "outgoing", "status": "pending", "createdOn": "2023-07-05T15:14:25.754Z", "lmodifiedOn": "2023-07-05T15:14:25.754Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "components": [{ "_id": "cp-2d5a6186-1b6b-5be3-ae5e-caaf556c7bbe", "cT": "text", "data": { "text": "" }, "thumbnails": [] }], 
     "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "lang": "en", "agentAssistDetails": { "streamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "srcChannel": "", "childBotStreamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "experience": "", "userInput": "refreshCS" }, "timestampValue": 1688570065756, "__v": 0, "sT": 1, "sessionId": "64a586161918a012c323b933", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-814af964-81a5-513c-ae3b-75b636d13317", "channels": [{ "to": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "incoming", "status": "received", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "lmodifiedBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "createdOn": "2023-07-05T15:14:32.417Z", "lmodifiedOn": "2023-07-05T15:14:32.417Z", "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "components": [{ "_id": "cp-9a435c9d-001b-5495-ae93-2675d25e2ec0", "cT": "text", "data": { "text": "payment dispute" }, "thumbnails": [] }], "timestampValue": 1688570072421, "__v": 0, "lang": "en", "sT": 1, "sessionId": "64a586161918a012c323b933", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-7951e5e2-79bc-5986-8d70-0dd9e25f3f63", "channels": [{ "to": "631993f5f7a27e7b3731acce/smartassist/64a588d10a931b1334858a31", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "outgoing", "status": "pending", "createdOn": "2023-07-05T15:14:32.938Z", "lmodifiedOn": "2023-07-05T15:14:32.938Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "components": [{ "_id": "cp-d7f425ec-077f-5445-be03-9bc001e84ea2", "cT": "text", "data": { "text": "" }, "thumbnails": [] }], "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "lang": "en", "agentAssistDetails": { "streamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "srcChannel": "", "childBotStreamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "experience": "", "userInput": "payment dispute" }, "timestampValue": 1688570072945, "__v": 0, "sT": 1, "sessionId": "64a586161918a012c323b933", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-b47294ad-be81-57b5-9ffa-571c9cc1e4c3", "channels": [{ "to": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "incoming", "status": "received", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "lmodifiedBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "createdOn": "2023-11-01T12:26:25.379Z", "lmodifiedOn": "2023-11-01T12:26:25.379Z", "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "components": [{ "_id": "cp-eecb5143-1b17-54f7-9a9a-c600bd73b742", "cT": "text", "data": { "text": "pizza" }, "thumbnails": [] }], "timestampValue": 1698841585384, "__v": 0, "lang": "en", "sT": 1, "sessionId": "654243f108efed7a1269cebc", "cluster_id": "Others", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-cb0a9047-7d95-5e51-97e7-6cfed5e50831", "channels": [{ "to": "631993f5f7a27e7b3731acce/smartassist/654243ecf735c179d4bec451", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "outgoing", "status": "pending", "createdOn": "2023-11-01T12:26:26.710Z", "lmodifiedOn": "2023-11-01T12:26:26.710Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "components": [{ "_id": "cp-9bbe4f30-8f2f-5618-80ba-2f638f3055dc", "cT": "text", "data": { "text": "{\"type\":\"template\",\"payload\":{\"template_type\":\"quick_replies\",\"text\":\"Select an option.\",\"quick_replies\":[{\"content_type\":\"text\",\"title\":\"Pizza\",\"payload\":\"Pizza\"},{\"content_type\":\"text\",\"title\":\"Wanna know anything about pizza ?\",\"payload\":\"Wanna know anything about pizza ?\"},{\"content_type\":\"text\",\"title\":\"Who are the other top pizza makers in the world?\",\"payload\":\"Who are the other top pizza makers in the world?\"},{\"content_type\":\"text\",\"title\":\"what is a pizza crust?\",\"payload\":\"what is a pizza crust?\"}]}}" }, "thumbnails": [] }], "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "lang": "en", "agentAssistDetails": { "streamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "srcChannel": "", "childBotStreamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "experience": "", "userInput": "pizza", "entityRequest": true, "ambiguityList": { "dialogs": [{ "name": "Pizza" }], "faqs": [{ "question": "Wanna know anything about pizza ?", "displayName": "Wanna know anything about pizza ?" }, { "question": "Who are the other top pizza makers in the world?", "displayName": "Who are the other top pizza makers in the world?" }, { "question": "what is a pizza crust?", "displayName": "what is a pizza crust?" }] }, "ambiguity": true, "isPrompt": true }, "timestampValue": 1698841586712, "__v": 0, "sT": 1, "sessionId": "654243ecf735c179d4bec451", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-472d7cfb-af72-5f41-a7da-5948364f8b7d", "channels": [{ "to": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "incoming", "status": "received", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "lmodifiedBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "createdOn": "2023-11-01T12:26:35.289Z", "lmodifiedOn": "2023-11-01T12:26:35.289Z", "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "components": [{ "_id": "cp-432e912d-d206-50e4-bb26-10b6ea6853eb", "cT": "text", "data": { "text": "Pizza" }, "thumbnails": [] }], "timestampValue": 1698841595293, "__v": 0, "lang": "en", "sT": 1, "sessionId": "654243f108efed7a1269cebc", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-d6ce20c0-df30-50ba-b789-17ff09225b0d", "channels": [{ "to": "631993f5f7a27e7b3731acce/smartassist/654243ecf735c179d4bec451", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "outgoing", "status": "pending", "createdOn": "2023-11-01T12:26:35.644Z", "lmodifiedOn": "2023-11-01T12:26:35.644Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "components": [{ "_id": "cp-6f56899b-3c8b-54d2-95ee-0aea0cb6e466", "cT": "text", "data": { "text": "" }, "thumbnails": [] }], "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "lang": "en", "agentAssistDetails": { "streamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "srcChannel": "", "childBotStreamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "experience": "", "userInput": "Pizza" }, "timestampValue": 1698841595646, "__v": 0, "sT": 1, "sessionId": "654243f108efed7a1269cebc", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-1bbfa8af-ae93-582b-a4ab-87ab461191ba", "channels": [{ "to": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "incoming", "status": "received", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "lmodifiedBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "createdOn": "2023-11-02T06:10:31.535Z", "lmodifiedOn": "2023-11-02T06:10:31.535Z", "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "components": [{ "_id": "cp-6f32f278-cf65-5f98-abe5-87c379e9e4a9", "cT": "text", "data": { "text": "payment dispute" }, "thumbnails": [] }], "timestampValue": 1698905431547, "__v": 0, "lang": "en", "sT": 1, "sessionId": "65433d57e55a38165822a4e5", "cluster_id": "Others", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-dd2c6d24-177f-5f14-ba3f-5d38612ff818", "channels": [{ "to": "631993f5f7a27e7b3731acce/smartassist/65433d5189a7b615fe1e4bd8", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "outgoing", "status": "pending", "createdOn": "2023-11-02T06:10:32.073Z", "lmodifiedOn": "2023-11-02T06:10:32.073Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "components": [{ "_id": "cp-5d7d7162-1788-5d4c-8608-fd15527dcf11", "cT": "text", "data": { "text": "" }, "thumbnails": [] }], "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "lang": "en", "agentAssistDetails": { "streamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "srcChannel": "", "childBotStreamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "experience": "", "userInput": "payment dispute" },
    "timestampValue": 1698905432075, "__v": 0, "sT": 1, "sessionId": "65433d57e55a38165822a4e5", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }, { "_id": "ms-6b3e2767-a2b0-5709-84ac-90dd0acd4e88", "channels": [{ "to": "631993f5f7a27e7b3731acce/smartassist/65433d5189a7b615fe1e4bd8", "type": "smartassist", "channelDispName": "SmartAssist" }], "type": "outgoing", "status": "pending", "createdOn": "2023-11-02T06:41:47.612Z", "lmodifiedOn": "2023-11-02T06:41:47.612Z", "createdBy": "u-38d2b42a-b677-5bba-bb1a-617fc0a9dae0", "components": [{ "_id": "cp-541ec9d3-de2d-595b-9e43-85685ddf77ee", "cT": "text", "data": { "text": "I am closing our current conversation as I have not received any input from you. We can start over when you need." }, "thumbnails": [] }], "botId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "orgId": "o-0ff7cd8c-ad52-5a4f-8c81-be37915314fa", "accountId": "631993f5f7a27e7b3731acce", "isBB": 0, "ms": 1, "chnl": "smartassist", "isD": 1, "lang": "en", "agentAssistDetails": { "streamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "srcChannel": "", "childBotStreamId": "st-47a6f5d9-5051-5eb1-8b20-3ae66b8cdf32", "experience": "", "userInput": "sending a ctrl message to CS" }, "timestampValue": 1698907307617, "__v": 0, "sT": 1, "sessionId": "65433d57e55a38165822a4e5", "resourceid": "messagestore", "tags": { "messageTags": [], "userTags": [{ "value": "", "name": "" }], "sessionTags": [] } }] }

    let userBotConversationDetails = this.rootService.getUserBotConvosDataDetails();
    let botId = userBotConversationDetails?.botId || params?.botId;
    let userId = userBotConversationDetails?.userId;
    let sessionId = userBotConversationDetails?.sessionId;  
    // if((userBotConversationDetails?.botId || this.rootService.connectionDetails?.botId) && userBotConversationDetails?.userId && userBotConversationDetails?.sessionId) {
      // this.serviceInvoker.invoke('get.userBotHistory', { botId: botId, convId: params.conversationId, userId, sessionId }, {}, { transcriptHistory: 'true', botId : botId }, params.agentassisturl).subscribe((data)=> {
        if(data && data.messages){
          this.historyResponse = data.messages;
          this.formatHistoryResponse();
        }
      // });
    // }
  }

  formatHistoryResponse(){
    for(let hisRes of this.historyResponse){
      hisRes = this.rootService.confirmationNodeRenderForHistoryDataTransform(hisRes);
      let result : any = this.templateRenderClassService.getResponseUsingTemplateForHistory(hisRes);
      hisRes.isTemplateRender = this.templateRenderCheck(hisRes,result);
      hisRes.template = this.rootService.getTemplateHtml(hisRes.isTemplateRender, result);
    }
    console.log(this.historyResponse, "history respjne**********");
    
  }

  renderHTMLPrompt(value) {
    let temp_hisRes = value
        if(temp_hisRes.includes('<vxml') && temp_hisRes.includes('</vxml>')) {
          return null;
        } else {
          temp_hisRes = this.rootService.handleEmptyLine(temp_hisRes, true);
          return temp_hisRes;
        }

  }

  templateRenderCheck(data,result){
    if(result.parsedPayload && ((data?.componentType === 'dialogAct' && (data?.srcChannel == 'msteams' || data?.srcChannel == 'rtm')) || (data?.componentType != 'dialogAct'))){
      return true;
    }
    return false;
  }

  ngOnDestroy(){
    this.subs.unsubscribe();
  }

}
