<app-slider-component #drawer id="drawer-slider" style="width: 0">
  <div fxFlex fxLayout="column" style="height: 100vh; width: 500px" *ngIf="isSliderLoading">
    <header fxFlex fxLayout fxLayoutAlign="flex-end">
      <!-- <mat-icon (click)="closeDrawer()">close</mat-icon> -->
      <div class="close-link col-4 p-0" (click)="closeDrawer()"><img src="assets/images/close.svg"></div>
    </header>
    <section fxFlex fxLayoutAlign="center center">
      <mat-spinner diameter="24"></mat-spinner>
    </section>
  </div>
  <div *ngIf="isFilter && !isSliderLoading" fxFlex="500px" fxLayout="column" fxLayoutGap="20px" id="filter-slider">
    <header fxFlex fxLayout fxLayoutAlign="space-between">
      <div fxFlex fxLayout fxLayoutGap="25px">
        <mat-icon (click)="closeDrawer()">
          <img src="assets/icons/agent-settings/arrow-back.svg">
        </mat-icon>
        <h1>{{ "CONVERSATIONAL_LOGS.FILTER" | translate }}</h1>
      </div>
      <div class="close-link col-4 p-0" (click)="closeDrawer()"><img src="assets/images/close.svg"></div>
    </header>
    <section>
      <form [formGroup]="filterForm" class="position-relative">
        <div class="date-gp">
          <span class="label">{{ "CONVERSATIONAL_LOGS.DATE_PERIOD" | translate }}</span>
          <span class="fromTo" [hidden]="!fromDate">{{fromDate}} {{ "CONVERSATIONAL_LOGS.TO" | translate }} {{toDate}}</span>
        </div>
        <mat-form-field floatLabel="never" appearance="outline" class="calendar">
          <mat-select formControlName="dateForm" [placeholder]="'PLACEHOLDERS.SELECT_DATE' | translate" (selectionChange)="onDateSelect($event)" disableOptionCentering panelClass="basic-select">
            <mat-option *ngFor="let range of rangeList" [value]="range.id">{{range.display}}</mat-option>
            <mat-option class="ngx-daterangepicker-action" (click)="openCalendar($event)" [value]="'Custom'"> {{ "CONVERSATIONAL_LOGS.CUSTOM" | translate }}</mat-option>
          </mat-select>
          <mat-icon class="ngx-daterangepicker-action" matSuffix (click)="openCalendar($event)" svgIcon="calendar"></mat-icon>
        </mat-form-field>
        <div class="custom_date_picker_sec filter-date-picker">
          <!-- <span class="fromTo d-none" *ngIf="isCustCalendar">{{calendarFromDate}} to {{calendarToDate}}</span> -->
          <input type="text" 
              readonly 
              ngxDaterangepickerMd 
              [alwaysShowCalendars]="true"
              [keepCalendarOpeningWithRange]="true"
              [ranges]="ranges"
              [linkedCalendars]="true"
              showCancel="true"
              [locale]="{format: 'DD/MM/YYYY hh:mm', displayFormat: 'MM/DD/YYYY hh:mm A'}"
              [isInvalidDate]="isInvalidDate"
              (startDateChanged)="startDateClicked($event)"
              (endDateChanged)="endDateClicked($event)"
              [locale] = "calendarLocale"
              #ngxDate
              class="input-date-custom d-none"
              (datesUpdated)="receiveMessage($event)"/>
        </div>
        <div class="label">{{ "CONVERSATIONAL_LOGS.FLOW_TYPE" | translate }}</div>
        <mat-form-field floatLabel="never" appearance="outline">
          <mat-select formControlName="flowTSel" multiple [placeholder]="'PLACEHOLDERS.SELECT_ALL' | translate" disableOptionCentering panelClass="flow-type">
            <mat-option #allSelected (click)="toggleAllSelection()" [value]="0">{{ "CONVERSATIONAL_LOGS.SELECT_ALL" | translate }}</mat-option>
            <mat-option *ngFor="let filterD of filterFlowType" (click)="tosslePerOne(allSelected.viewValue)" [value]="filterD.id">{{filterD.name}}</mat-option>
          </mat-select>
        </mat-form-field>
        <div class="label">{{ "CONVERSATIONAL_LOGS.STATUS" | translate }}</div>
        <mat-form-field floatLabel="never" appearance="outline">
          <mat-select formControlName="statusForm" [placeholder]="'PLACEHOLDERS.SELECT_ALL' | translate" disableOptionCentering panelClass="basic-select">
            <mat-option [value]="''">{{ "CONVERSATIONAL_LOGS.SELECT_ALL" | translate }}</mat-option>
            <mat-option *ngFor="let filterD of filterStatus" [value]="filterD.id">{{filterD.name}}</mat-option>
          </mat-select>
        </mat-form-field>
        <div class="label">{{ "CONVERSATIONAL_LOGS.INTENT_IDENTIFIED" | translate }}</div>
        <mat-form-field appearance="outline" floatLabel="never">
          <mat-select formControlName="intentIdentified" [placeholder]="'PLACEHOLDERS.SELECT_ALL' | translate" disableOptionCentering panelClass="basic-select">
            <mat-option [value]="''">{{ "CONVERSATIONAL_LOGS.SELECT_ALL" | translate }}</mat-option>
            <mat-option *ngFor="let flow of flowTypeList" [value]="flow.usecaseName">{{flow.usecaseName}}</mat-option>
          </mat-select>
        </mat-form-field>
      </form>
    </section>
    <footer>
      <button class="kr-sg-button-primary btn_md mr-2"  (click)="applyFilter()">{{ "CONVERSATIONAL_LOGS.APPLY" | translate }}</button>
      <button class="kr-sg-button-secondary btn_md"  (click)="resetFilters()">{{ "BUTTONS.RESET" | translate }}</button>
    </footer>
  </div>
  <div *ngIf="isInsights && !isSliderLoading" fxFlex="500px" fxLayout="column" id="insights-main">
    <header fxFlex fxLayout fxLayoutAlign="space-between">
      <div fxFlex fxLayout fxLayoutGap="25px">
        <mat-icon (click)="closeDrawer()">{{"CONVOS.LOGS.KEYBOARD_BS" | translate}}</mat-icon>
        <h1>{{ "CONVERSATIONAL_LOGS.INSIGHTS_TO_LOGS" | translate }}</h1>
      </div>
      <!-- <mat-icon (click)="closeDrawer()">close</mat-icon> -->
      <div class="close-link col-4 p-0" (click)="closeDrawer()"><img src="assets/images/close.svg"></div>
    </header>
    <section fxFlex class="mat-tab-custom-conv">
      <mat-tab-group #tabGroup [selectedIndex]="selectedTabIndex">
        <mat-tab label="CONVERSATIONAL FLOW">
          <perfect-scrollbar style="height: calc(100vh - 145px)">
            <section *ngIf="flowList.length">
                <div *ngFor="let flow of flowList; let i = index">
                  <div class="vert" [hidden]="i == 0"></div>
                  <div class="light-purple">
                    {{flow[0]}}
                    <div class="vert" *ngIf="!flow[1].length"></div>
                  </div>
                  <div *ngFor="let f of flow[1]">
                    <div class="vert"></div>
                    <div class="grey" *ngIf="f !== flow[0]">{{f}}</div>
                    <div class="vert"></div>
                  </div>
                </div>
                <div *ngIf="selectedLog.status == 'drop-off'">
                  <div class="vert"></div>
                  <div class="orange">{{ "CONVERSATIONAL_LOGS.DROP_OFF" | translate }}</div>
                  <div class="vert"></div>
                </div>
            </section>
            <section *ngIf="!flowList.length" class="flow-error">
              <mat-icon>{{"WARNING_AMBER" | translate}}</mat-icon>
              <span>{{ "CONVERSATIONAL_LOGS.NO_CONVERS_FLOW" | translate }}</span>
            </section>
          </perfect-scrollbar>
        </mat-tab>
        <mat-tab label="CHAT HISTORY">
          <section style="padding: 0;overflow: hidden;">
            <div class="load-logs" *ngIf="isInProgress">
                <mat-spinner diameter="18" strokeWidth="2"></mat-spinner>
                <span class="wait-message">{{ "CONVERSATIONAL_LOGS.LOADING" | translate }}</span>
            </div>
            <div class="chat-history-container" *ngIf="!isInProgress">
              <app-templates-chat-history [chatData]="chatHistData" [msgId]="messageId" [selectedLog]="selectedLog"></app-templates-chat-history>
            </div>
          </section>         
        </mat-tab>
      </mat-tab-group>
    </section>
  </div>
</app-slider-component>


<div fxFlex class="con-logs-main" *ngIf="!isCallLogs">
  <div style="padding: 40px 50px 45px 50px;" fxFlex fxLayout='column'>
    <header fxFlex fxLayout fxLayoutAlign="space-between" class="logs-head">
      <h1 fxFlex fxLayoutAlign="flex-start" class="m-0">{{ "CONVERSATIONAL_LOGS.CONVERS_LOGS" | translate }}</h1>
      <div fxFlex fxLayout fxLayoutAlign="flex-end" fxLayoutGap="10px">
        <!-- <button mat-icon-button color="primary" class="filter-button" (click)="openFilter()">
          <mat-icon svgIcon="filter_icon"></mat-icon>Filter
        </button> -->        
        <button (click)="openFilter()" class="kr-sg-button-primary btn_lg pl-pr-10"><img src="assets/icons/conversational-logs/add.svg" class="mr-2">{{ "CONVERSATIONAL_LOGS.FILTER" | translate }}</button>
        <div class="exp-icon" [hidden]="dataSource?.length == 0" [class.disabled]="isExporting" (click)="exportConverLogs()">
          <img src="assets/icons/conversational-logs/export.svg">
        </div>
      </div>
      <div class="close-link col-4 p-0" (click)="onCloseCDR()" *ngIf="isFromAnalytics"><img src="assets/images/close.svg"></div>
    </header>
    <header class="search">
      <div class="kr-sg-input-inline-search">
        <input type="text" [placeholder]="'PLACEHOLDERS.SEARCH_PH_NUMBER' | translate" #inpSearch class="input-search">
        <img src="assets/icons/search.svg" class="search-icon">
      </div>
    </header>
    <section>
      <perfect-scrollbar style="height: calc(100vh - 220px)"  (psYReachEnd)="onReachEnd()">
        <mat-table [dataSource]="dataSource" matSort (matSortChange)="sortData($event)">
          <ng-container matColumnDef="phone">
            <mat-header-cell *matHeaderCellDef>{{ "CONVERSATIONAL_LOGS.PHONE_NUMBER" | translate }}</mat-header-cell>
            <mat-cell style="word-break: break-all;" *matCellDef="let element">
              {{element.phoneNumber}}
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="date">
            <mat-header-cell *matHeaderCellDef mat-sort-header="date">{{ "CONVERSATIONAL_LOGS.START_DATE_TIME" | translate }}<mat-icon svgIcon="sorting"></mat-icon></mat-header-cell>
            <mat-cell *matCellDef="let element" fxFlex fxLayout="column" fxLayoutAlign="start start">
              <div class="ele-date">
                {{element.startedOn.format('Do MMM, YYYY')}}
              </div>
              <div class="ele-time">
                {{element.startedOn | date:'mediumTime'}}
              </div>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="duration">
            <mat-header-cell *matHeaderCellDef mat-sort-header>{{ "CONVERSATIONAL_LOGS.DURATION" | translate }}<mat-icon svgIcon="sorting"></mat-icon></mat-header-cell>
            <mat-cell *matCellDef="let element">
              <div *ngIf="element.status !== 'not connected'">{{durationCalc(element.duration)}}</div>
              <div *ngIf="element.status == 'not connected'">0</div>
            </mat-cell>
          </ng-container>
          <!-- <ng-container matColumnDef="intent">
            <mat-header-cell *matHeaderCellDef>{{ "CONVERSATIONAL_LOGS.INTENT_IDENTIFIED_CAPS" | translate }}</mat-header-cell>
            <mat-cell *matCellDef="let element" matTooltip="{{element.intentIdentified?.join(' > ')}}" [matTooltipPosition]="'above'" style="color: #009DAB">{{ (element.intentIdentified?.join(' > ').length>15)? (element.intentIdentified?.join(' > ') | slice:0:15)+'..':(element.intentIdentified?.join(' > ')) || "CONVERSATIONAL_LOGS.NO_INTENTS" | translate }}</mat-cell>
          </ng-container>
          <ng-container matColumnDef="flow">
            <mat-header-cell *matHeaderCellDef>{{ "CONVERSATIONAL_LOGS.FLOW_TYPE_CAPS" | translate }}</mat-header-cell>
            <mat-cell *matCellDef="let element">
              <div *ngFor="let flow of element.flow; let last = last">
                <mat-icon svgIcon="agent_voice" style="width: 18px" *ngIf="flow == 'voiceAgentTransferStart'" matTooltip="Call Agent" matTooltipPosition="above"></mat-icon>
                <mat-icon svgIcon="agent_chat" style="width: 19px" *ngIf="flow == 'agentTransferStart'" matTooltip="Chat Agent" matTooltipPosition="above"></mat-icon>
                <mat-icon svgIcon="conver_chat" style="width: 33px" *ngIf="flow == 'chatAutomation'" matTooltip="Chat Automation" matTooltipPosition="above"></mat-icon>
                <mat-icon svgIcon="conver_voice" style="width: 30px" *ngIf="flow == 'voiceAutomation'" matTooltip="Voice Automation" matTooltipPosition="above"></mat-icon>
                <span class="gt-icon" *ngIf="(flow == 'voiceAgentTransferStart' || flow == 'agentTransferStart' || flow == 'chatAutomation' || flow == 'voiceAutomation') && !last">></span>
              </div>
            </mat-cell>
          </ng-container> -->
          <ng-container matColumnDef="status">
            <mat-header-cell *matHeaderCellDef>{{ "CONVERSATIONAL_LOGS.STATUS_CAPS" | translate }}</mat-header-cell>
            <mat-cell *matCellDef="let element" [ngStyle]="{'color': element.status == 'drop-off'?'#FF5722':element.status === 'fulfilled'?'#28A745':element.status == 'not connected'?'#DD3646':'#2196F3'}">{{element.status | titlecase}}</mat-cell>
          </ng-container>
          <ng-container matColumnDef="recording">
            <mat-header-cell *matHeaderCellDef>{{ "CONVERSATIONAL_LOGS.RECORDING" | translate }}</mat-header-cell>
            <mat-cell *matCellDef="let element">
              <mat-icon svgIcon="play" (click)="selectedTabIndex = 1" style="width: 13px" matTooltip="Play" matTooltipPosition="above"></mat-icon>
              <mat-icon svgIcon="download" (click)="downloadAudioRecording($event, element)" style="width: 13px" class="ml-3" matTooltip="Download" matTooltipPosition="above"></mat-icon>
            </mat-cell>
          </ng-container>
          <mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></mat-header-row>
          <mat-row *matRowDef="let row; columns: displayedColumns;" [ngClass]="{'blue': row.isActive}" (click)="openLogs(row)"></mat-row>
        </mat-table>
        <div class="load-logs" *ngIf="isMoreAvailable">
          <mat-spinner diameter="18"></mat-spinner>
          {{ "CONVERSATIONAL_LOGS.LOADING_LOGS" | translate }}
        </div>
        <div *ngIf="dataSource?.data.length == 0" class="warning-message">
          <!-- <mat-icon>warning_amber</mat-icon> -->
          <img src="assets/icons/deployment-icons/warning.svg">
          <span>{{ "CONVERSATIONAL_LOGS.NO_LOGS_AVAILABLE" | translate }}</span>
        </div>
      </perfect-scrollbar>
    </section>
  </div>
</div>
<div *ngIf="isCallLogs" fxFlex fxLayout fxLayoutAlign="center center" style="height: 90vh">
  <mat-spinner diameter="18"></mat-spinner>
</div>

